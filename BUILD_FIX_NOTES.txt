# Build Script Fix - Directory Creation Issue

## Problem 1: Directory Creation Error

When running `sudo bash build.sh`, the build failed with:
```
cp cannot create regular file '/home/dev/PANELSV/debian/usr/local/bin/easypanel-bin' 
no such file or directory
```

### Root Cause 1
The build script was attempting to copy files before ensuring that the target directories existed.

### Solution 1
Updated `build.sh` to create all necessary directories before attempting file copies.

**Changes Made to build.sh:**
- Added `mkdir -p "$SCRIPT_DIR/debian/usr/local/bin"` before copying main.sh
- Added `mkdir -p "$SCRIPT_DIR/debian/usr/local/lib/easypanel/modules"` before copying modules
- Removed redundant mkdir commands

---

## Problem 2: Permission Denied Error (APT)

After build succeeds, installation fails with:
```
download is performed unsandboxed as root as file 'home/dev/PANELSV/dist/easypanel_1.0.0_all.deb' 
could not be accessed by user '_apt'. - pkgAcquire::Run (13: permission denied)
```

### Root Cause 2
The `.deb` file and/or directories were created with restricted permissions that prevent `_apt` user from reading them during installation.

### Solution 2
Updated `build.sh` to set proper permissions on:
1. The output directory (dist/)
2. All files and directories in the debian package structure
3. The final .deb file

**Changes Made to build.sh:**

1. **Output directory permissions (Line 22):**
   ```bash
   chmod 755 "$OUTPUT_DIR"
   ```

2. **Directory and file permissions in package (Lines 53-55):**
   ```bash
   find "$SCRIPT_DIR/debian" -type d -exec chmod 755 {} \;
   find "$SCRIPT_DIR/debian" -type f ! -path '*/DEBIAN/*' -exec chmod 644 {} \;
   find "$SCRIPT_DIR/debian/DEBIAN" -type f -exec chmod 755 {} \;
   ```

3. **.deb file permissions after build (Line 65):**
   ```bash
   chmod 644 "$PACKAGE_FILE"
   ```

---

## Permission Structure

After these fixes, the permissions are:

```
dist/                          755  (readable by all)
  easypanel_1.0.0_all.deb      644  (readable by all, writable by owner)
  
debian/
  usr/
    local/
      bin/                     755  (directories readable/executable by all)
      lib/easypanel/           755
        modules/               755
      
  DEBIAN/                      755  (control files executable)
    preinst                    755
    postinst                   755
    postrm                     755
    
  etc/easypanel/               755  (config dirs readable)
  
  [other files]                644  (regular files readable by all)
```

---

## How to Build Now

```bash
sudo bash build.sh
```

The script will now:
1. ✅ Create necessary directories
2. ✅ Copy all source files
3. ✅ Set proper permissions (directories 755, files 644, scripts 755)
4. ✅ Generate md5sums
5. ✅ Build the .deb package
6. ✅ Set .deb file permissions to 644
7. ✅ Generate SHA256 checksum

## Installation

After build succeeds:

```bash
sudo dpkg -i dist/easypanel_1.0.0_all.deb
```

Or with apt:

```bash
sudo apt install -y ./dist/easypanel_1.0.0_all.deb
```

Note: Use `./dist/` when using `apt` to tell it this is a local file.

## Build Output

If successful, you'll see:
```
EasyPanel Package Builder v1.0.0
======================================

Preparing package files...
Creating md5sums...
Building .deb package...

✓ Package built successfully!
  Output: ./dist/easypanel_1.0.0_all.deb
  Size: [SIZE]

Package Information:
[Package details...]
```

## Verification After Installation

```bash
sudo easypanel
```

This should now start the main menu without permission errors.

---

## Summary of Fixes

| Issue | Root Cause | Fix | Line |
|-------|-----------|-----|------|
| Directory missing | No mkdir before cp | Added mkdir -p | 27-28 |
| APT can't read .deb | Restricted file perms | chmod 644 on .deb | 65 |
| Config can't be read | Restricted dir perms | chmod 755 on dirs | 53 |
| Regular file perms | Not set after copy | chmod 644 on files | 54 |
| Scripts not executable | Perms not reset | chmod 755 DEBIAN/* | 55 |

---

**Fixes Applied:** Current Session
**Status:** ✅ Ready for use
**Build Status:** Should now work without directory or permission errors

